load_staffs = () ->
  staffs = null
  $.ajax({
    async: false,
    type: "GET",
    url: "<%= url_for "/staffs" %>",
    data: { project: project_key },
    dataType: 'json',
  }).done((data) ->
    staffs = data
  )

  $.each(staffs, (i) ->
    staff = add_staff_html(this._id, this.name, this.color)

    if this.task_id
      staff.find('.assigned-task').append($('#task_' + this.task_id))
  )

setup_add_staff_link = () ->
  $('#add-staff').click(add_staff_event)

add_staff_event = () ->
  name = window.prompt('名前を入力してください')
  if name
    add_staff(name)

add_staff = (name) ->
  # send to server
  staff_id = null
  $.ajax({
    async: false,
    type: "POST",
    url: "<%= url_for "/new_staff" %>",
    data: { project: project_key, name: name }
  }).done((id) ->
    staff_id = id
  )

  # @todo color rotation
  add_staff_html(staff_id, name, 'orange')

add_staff_html = (id, name, color) ->
  # copy element
  new_staff = $('#staff-template').clone()
  new_staff.attr('id', 'staff_' + id)
  new_staff.data('id', id)

  new_staff.find('.staff-name').addClass('color-' + color)
  new_staff.find('.name').text(name)

  new_staff.show()

  # assigned tasks
  new_staff.find(".assigned-task").sortable({
    connectWith: "#tasks,.assigned-task",
    helper: "clone", # prevent firing click event on dragging

    receive: (event, ui) ->
      if $(this).find('li').length >= 2
        # Don't assign multiple tasks to one person
        $(ui.sender).sortable('cancel')
      else if ui.item.hasClass('ui-state-disabled')
        # avoid completed task assign
        $(ui.sender).sortable('cancel')
      else
        $.ajax({
          async: true,
          type: "POST",
          url: "<%= url_for "/assign_task" %>",
          data: {
            project: project_key,
            task_id: ui.item.data('id'),
            staff_id: $(this).parent().data('id'),
          },
          dataType: 'json',
        })

    stop: (event, ui) ->
      # if task was completed, hide and move to incoming list
      # should be in trashbox's drop handler, but there is timing problem
      if ui.item.hasClass('ui-state-disabled')
        if !$('#show_trashes_check').attr('checked')
          ui.item.hide()

        $('#tasks').append(ui.item)
  })

  enable_inplace_edit(new_staff.find('.staff-name'), '<%= url_for "/edit_staff" %>')
  enable_inplace_delete(new_staff.find('.staff-name'), '<%= url_for "/delete_staff" %>')

  $("#staffs").append(new_staff)
  new_staff
