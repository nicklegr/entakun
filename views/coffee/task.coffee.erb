setup_task_list = () ->
  $("#tasks").sortable({
    connectWith: "ul.assigned-task",
    cancel: ".ui-state-disabled", # disable sorting completed tasks

    receive: (event, ui) ->
      $.ajax({
        async: true,
        type: "POST",
        url: "<%= url_for "/deassign_task" %>",
        data: { project: project_key, task_id: ui.item.data('id') },
        dataType: 'json',
      })

    update: (event, ui) ->
      data = $("#tasks").sortable('serialize')
      data = data.replace(/.*template&/, '') # remove template element
      data = "project=#{project_key}&" + data
      $.post("<%= url_for "/task_sorted" %>", data)

    stop: (event, ui) ->
      # if task was completed, move to last
      # should be in trashbox's drop handler, but there is timing problem
      if ui.item.hasClass('ui-state-disabled')
        $('#tasks').append(ui.item)
  })

setup_task_input = () ->
  $("input#task").keypress((event) ->
    text = $("input#task").val()

    if text != "" && (event.keyCode && event.keyCode == 13)
      add_task(text)
      $("input#task").val('')
  )

load_tasks = () ->
  tasks = null
  $.ajax({
    async: false,
    type: "GET",
    url: "<%= url_for "/tasks" %>",
    data: { project: project_key },
    dataType: 'json',
  }).done((data) ->
    tasks = data
  )

  $.each(tasks, (i) ->
    task = add_task_html(this._id, this.name)
    if this.complete
      task.addClass('ui-state-disabled')
      if !$('#show_trashes_check').attr('checked')
        task.hide()
  )

add_task = (name) ->
  # send to server
  task_id = null
  $.ajax({
    async: false,
    type: "POST",
    url: "<%= url_for "/new_task" %>",
    data: { project: project_key, name: name }
  }).done((id) ->
    task_id = id
  )

  add_task_html(task_id, name)

add_task_html = (id, name) ->
  # copy element
  new_task = $('#task-template').clone()
  new_task.attr('id', 'task_' + id)
  new_task.data('id', id)
  new_task.find('.name').text(name)
  new_task.show()

  enable_inplace_edit(new_task, '<%= url_for "/edit_task" %>', null, true)
  enable_inplace_delete(new_task, '<%= url_for "/delete_task" %>')

  # if there is completed task, insert before them
  completes = $('#tasks').find('.ui-state-disabled')
  if completes.length > 0
    completes.first().before(new_task)
  else
    $("ul#tasks").append(new_task)

  new_task
